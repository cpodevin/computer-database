<?xml version = "1.0" encoding = "UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:mvc="http://www.springframework.org/schema/mvc"
	xmlns:security="http://www.springframework.org/schema/security"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
   http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
   http://www.springframework.org/schema/context
   http://www.springframework.org/schema/context/spring-context-3.0.xsd
   http://www.springframework.org/schema/mvc
   http://www.springframework.org/schema/mvc/spring-mvc.xsd
   http://www.springframework.org/schema/security
   http://www.springframework.org/schema/security/spring-security-4.2.xsd">


	<context:component-scan
		base-package="com.excilys.cdb.controller" />
	<mvc:annotation-driven />
	<!-- bean definitions go here -->

	<bean id="myProperties"
		class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
		<property name="locations">
			<list>
				<value>classpath:hikari.properties</value>
			</list>
		</property>
	</bean>

	<bean id="computerDAO" class="com.excilys.cdb.dao.ComputerDAO"
		scope="singleton" autowire="byName"></bean>

	<bean id="companyDAO" class="com.excilys.cdb.dao.CompanyDAO"
		scope="singleton" autowire="byName"></bean>

	<bean id="userDAO" class="com.excilys.cdb.dao.UserDAO"
		scope="singleton" autowire="byName"></bean>

	<bean id="computerService"
		class="com.excilys.cdb.service.ComputerService" scope="singleton"
		autowire="byName"></bean>

	<bean id="companyService"
		class="com.excilys.cdb.service.CompanyService" scope="singleton"
		autowire="byName"></bean>

	<bean id="computerMapper"
		class="com.excilys.cdb.dto.ComputerMapper" scope="singleton"></bean>

	<bean id="companyMapper" class="com.excilys.cdb.dto.CompanyMapper"
		scope="singleton"></bean>

	<bean id="validator"
		class="com.excilys.cdb.dto.ComputerDTOValidator" scope="singleton"></bean>


	<bean id="dataSource"
		class="org.springframework.jdbc.datasource.DriverManagerDataSource">
		<property name="driverClassName" value="${driverClassName}" />
		<property name="url" value="${jdbcUrl}" />
		<property name="username" value="${username}" />
		<property name="password" value="${password}" />
	</bean>

	<bean id="jdbcTemplate"
		class="org.springframework.jdbc.core.JdbcTemplate">
		<property name="dataSource" ref="dataSource" />
	</bean>

	<bean id="sessionFactory"
		class="org.springframework.orm.hibernate5.LocalSessionFactoryBean">
		<property name="dataSource" ref="dataSource" />
		<property name="packagesToScan"
			value="com.excilys.cdb.model.*" />
		<property name="mappingLocations"
			value="classpath*:properties/*.hbm.xml" />
		<property name="hibernateProperties">
			<props>
				<prop key="hibernate.hbm2ddl.auto">
					update
				</prop>
				<prop key="hibernate.allow_update_outside_transaction">
					true
				</prop>
				<prop key="hibernate.dialect">
					org.hibernate.dialect.MySQLDialect
				</prop>
			</props>
		</property>
	</bean>

	<bean id="queryFactory"
		class="com.querydsl.jpa.impl.JPAQueryFactory">
		<constructor-arg>
			<bean factory-bean="sessionFactory"
				factory-method="createEntityManager"></bean>
		</constructor-arg>
	</bean>

	<bean id="ViewResolver"
		class="org.springframework.web.servlet.view.InternalResourceViewResolver">
		<property name="ViewClass"
			value="org.springframework.web.servlet.view.JstlView"></property>
		<property name="prefix">
			<value>/views/</value>
		</property>
		<property name="suffix">
			<value>.jsp</value>
		</property>
	</bean>

	<mvc:interceptors>
		<bean
			class="org.springframework.web.servlet.i18n.LocaleChangeInterceptor">
			<property name="paramName" value="lang" />
		</bean>
	</mvc:interceptors>

	<bean id="messageSource"
		class="org.springframework.context.support.ReloadableResourceBundleMessageSource">
		<property name="basename"
			value="classpath:languages/language" />
		<property name="defaultEncoding" value="UTF-8" />
	</bean>

	<bean id="localeResolver"
		class="org.springframework.web.servlet.i18n.SessionLocaleResolver">
		<property name="defaultLocale" value="en" />
	</bean>


	<bean id="userService" class="com.excilys.cdb.service.UserService" />
	<security:http-firewall
		ref="defaultHttpFirewall" />
	<security:authentication-manager>
		<security:authentication-provider
			user-service-ref="userService">
			<security:password-encoder
				ref="passwordEncoder">
			</security:password-encoder>
		</security:authentication-provider>
	</security:authentication-manager>
	<security:http>
		<security:intercept-url pattern="/login*" access="permitAll()" />
		<security:intercept-url pattern="/create*" access="permitAll()" />
		<security:intercept-url pattern="/**"
			access="hasRole('ROLE_ADMIN')" method="POST" />
		<security:intercept-url pattern="/**"
			access="hasAnyRole('ROLE_USER','ROLE_ADMIN')" method="GET" />
		<security:form-login />
		<security:logout />
	</security:http>
	<bean id="passwordEncoder" class="org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder" > 
		</bean>
	<bean id="defaultHttpFirewall"
		class="org.springframework.security.web.firewall.DefaultHttpFirewall" />

</beans>
